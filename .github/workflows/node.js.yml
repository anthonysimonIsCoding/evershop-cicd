name: EverShop CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    env:
      NODE_ENV: test
      DB_HOST: localhost
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: 123
      DB_NAME: postgres
      SUPPRESS_NO_CONFIG_WARNING: true  # tắt cảnh báo config
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20   # Joi yêu cầu Node >= 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Start PostgreSQL
        uses: harmon758/postgresql-action@v2
        with:
          postgresql version: '16'
          postgresql db: ${{ env.DB_NAME }}
          postgresql user: ${{ env.DB_USER }}
          postgresql password: ${{ env.DB_PASSWORD }}

      - name: Start EverShop server
        run: |
          echo "Starting EverShop server..."
          npm run start &> server.log &   # log đầy đủ ra file
          echo "Waiting for server to be ready..."
          npx wait-on --timeout 120000 http://localhost:3000
          echo "Server is ready!"
          tail -n 50 server.log           # show 50 dòng log cuối cùng

      - name: Run tests
        run: npm test
